

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>src.drfsc &mdash; drfsc 0.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> drfsc
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">src</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">drfsc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>src.drfsc</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for src.drfsc</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">statsmodels.discrete.discrete_model</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">src.rfsc</span> <span class="kn">import</span> <span class="n">RFSC</span><span class="p">,</span> <span class="n">RFSC_base</span>

<div class="viewcode-block" id="DRFSC"><a class="viewcode-back" href="../../src.html#src.drfsc.DRFSC">[docs]</a><span class="k">class</span> <span class="nc">DRFSC</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Distributed Randomised Feature Selection for Classification (DRFSC)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">n_vbins</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
            <span class="n">n_hbins</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
            <span class="n">n_runs</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
            <span class="n">redistribute_features</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
            <span class="n">feature_sharing</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> 
            <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
            <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">,</span> 
            <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">,</span> 
            <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
            <span class="n">polynomial</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
            <span class="n">preprocess</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
            <span class="n">max_processes</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor for DRFSC class. Initialises the DRFSC class with the given parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_vbins : int, optional</span>
<span class="sd">            Number of vertical partitions to create for the data. Defaults to 1.</span>
<span class="sd">        n_hbins : int, optional</span>
<span class="sd">            Number of horizontal partitions to create for the data. If output = &#39;ensemble&#39;, each hbin will converge to its own best model. Defaults to 1.</span>
<span class="sd">        n_runs : int, optional</span>
<span class="sd">            Number of feature-sharing iterations to perform. Larger numbers may yield better results, but also take longer. Defaults to 1.</span>
<span class="sd">        redistribute_features : bool, optional</span>
<span class="sd">            If True, the base features included in each bin will be shuffled at each feature-sharing iteration. Does not affect feature sharing. Defaults to False.</span>
<span class="sd">        feature_sharing : str, optional </span>
<span class="sd">            The method used to share features. Defaults to &#39;all&#39;. Options (str): &#39;all&#39;, &#39;latest&#39;, &#39;top_k&#39;. If feature_sharing = &#39;all&#39;, the entire history of best features from all sub-processes will be shared. If feature)sharing = &#39;latest&#39;, features from all sub-processes at the current iteration will be shared. If feature_sharing = &#39;top_k&#39;, the best k features will be shared. </span>
<span class="sd">        k : int, optional </span>
<span class="sd">            Number of best features to share. Only used if feature_sharing = &#39;top_k&#39;. Defaults to 0.</span>
<span class="sd">        output : str, optional</span>
<span class="sd">            Output type desired. Options (str): &#39;single&#39;, &#39;ensemble&#39;. If output = &#39;single&#39;, the best model from all sub-processes will be returned. If output = &#39;ensemble&#39;, the best model from each horizontal partition will be returned. If output = &#39;ensemb;e&#39;. no features between different horizontal partitions will be created. Defaults to &#39;single&#39;.</span>
<span class="sd">        metric : str, optional</span>
<span class="sd">            Evaluation metric used in the optimisation process. Options (str) : [&#39;acc&#39;, &#39;roc_auc&#39;, &#39;weighted&#39;, &#39;avg_prec&#39;, &#39;f1&#39;, &#39;auprc&#39;]. Defaults to &#39;roc_auc&#39;. For more information on the metrics, see the documentation for the sklearn.metrics module.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            if True, prints extra information. Defaults to False.</span>
<span class="sd">        polynomial : int, optional</span>
<span class="sd">            degree of polynomial features to use. Defaults to 1.</span>
<span class="sd">        preprocess : bool, optional</span>
<span class="sd">            If True, will scale-data, create dummies for categorical variables, and create polynomial features based on passed `polynomial` parameter. If False, will only convert data to numpy arrays. Defaults to True.</span>
<span class="sd">        max_processes : int, optional</span>
<span class="sd">            Enforces maximum number of processes that can be generated. If None, will use all available cores. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">validate_model</span><span class="p">(</span>
            <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> 
            <span class="n">n_hbins</span><span class="o">=</span><span class="n">n_hbins</span><span class="p">,</span> 
            <span class="n">n_vbins</span><span class="o">=</span><span class="n">n_vbins</span><span class="p">,</span> 
            <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span> 
            <span class="n">feature_sharing</span><span class="o">=</span><span class="n">feature_sharing</span><span class="p">,</span> 
            <span class="n">k</span><span class="o">=</span><span class="n">k</span>
        <span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_vbins</span> <span class="o">=</span> <span class="n">n_vbins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_hbins</span> <span class="o">=</span> <span class="n">n_hbins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_runs</span> <span class="o">=</span> <span class="n">n_runs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redistribute_features</span> <span class="o">=</span> <span class="n">redistribute_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_sharing</span> <span class="o">=</span> <span class="n">feature_sharing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polynomial</span> <span class="o">=</span> <span class="n">polynomial</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span> <span class="o">=</span> <span class="n">preprocess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_data</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_processes</span> <span class="o">=</span> <span class="n">max_processes</span> <span class="k">if</span> <span class="n">max_processes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RFSC_model</span> <span class="o">=</span> <span class="n">RFSC_base</span><span class="p">(</span><span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> Initialised with parameters: </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">            n_vbins = </span><span class="si">{</span><span class="n">n_vbins</span><span class="si">}</span><span class="s2">, </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">            n_hbins = </span><span class="si">{</span><span class="n">n_hbins</span><span class="si">}</span><span class="s2">, </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">            n_runs = </span><span class="si">{</span><span class="n">n_runs</span><span class="si">}</span><span class="s2">, </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">            redistribute = </span><span class="si">{</span><span class="n">redistribute_features</span><span class="si">}</span><span class="s2">, </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">            sharing = </span><span class="si">{</span><span class="n">feature_sharing</span><span class="si">}</span><span class="s2">, </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">            k = </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">, </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">            output = </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">, </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">            metric = </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">, </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">            max_processes is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_processes</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> ------------&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(n_vbins=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_vbins</span><span class="si">}</span><span class="s2">, n_hbins=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_hbins</span><span class="si">}</span><span class="s2">, n_runs=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_runs</span><span class="si">}</span><span class="s2">, redistribute_features=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">redistribute_features</span><span class="si">}</span><span class="s2">, feature_sharing=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_sharing</span><span class="si">}</span><span class="s2">, k=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="si">}</span><span class="s2">, output=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="si">}</span><span class="s2">, metric=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="si">}</span><span class="s2">, verbose=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="si">}</span><span class="s2">, polynomial=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">polynomial</span><span class="si">}</span><span class="s2">, preprocess=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="si">}</span><span class="s2">, max_processes=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_processes</span><span class="si">}</span><span class="s2">)&quot;</span>
        
<div class="viewcode-block" id="DRFSC.get_rfsc_params"><a class="viewcode-back" href="../../src.html#src.drfsc.DRFSC.get_rfsc_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_rfsc_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Getter for RFSC parameters. Returns a dictionary of the current RFSC parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">RFSC_model</span><span class="o">.</span><span class="vm">__dict__</span></div>
        
<div class="viewcode-block" id="DRFSC.set_rfsc_params"><a class="viewcode-back" href="../../src.html#src.drfsc.DRFSC.set_rfsc_params">[docs]</a>    <span class="k">def</span> <span class="nf">set_rfsc_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setter for RFSC parameters. Updates the RFSC parameters with the given dictionary. Dictionary must be in the form of {parameter_name: parameter_value}.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_models : int </span>
<span class="sd">            Number of models generated per iteration. Default=300.</span>
<span class="sd">        n_iters : int </span>
<span class="sd">            Number of iterations. Default=150.</span>
<span class="sd">        tuning : float </span>
<span class="sd">            Learning rate that dictates the speed of regressor inclusion probability (rip) convergence. Smaller values -&gt; slower convergence. Default=50.</span>
<span class="sd">        tol : float </span>
<span class="sd">            Tolerance condition. Default=0.002.</span>
<span class="sd">        alpha : float </span>
<span class="sd">            Significance level for model pruning. Default=0.99.</span>
<span class="sd">        rip_cutoff : float </span>
<span class="sd">            Determines rip threshold for feature inclusion in final model. Default=1.</span>
<span class="sd">        metric : str</span>
<span class="sd">            Optimization metric. Default=&#39;roc_auc&#39;. Options: &#39;acc&#39;, &#39;roc_auc&#39;, &#39;weighted&#39;, &#39;avg_prec&#39;, &#39;f1&#39;, &#39;auprc&#39;.</span>
<span class="sd">        verbose : bool </span>
<span class="sd">            Provides extra information. Defaults=False.</span>
<span class="sd">        upweight : float </span>
<span class="sd">            Upweights initial feature rips. Default=1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RFSC_model</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated RFSC model parameters: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">RFSC_model</span><span class="o">.</span><span class="vm">__dict__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="DRFSC.generate_processes"><a class="viewcode-back" href="../../src.html#src.drfsc.DRFSC.generate_processes">[docs]</a>    <span class="k">def</span> <span class="nf">generate_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v_bins</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">h_bins</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">):</span> <span class="n">RFSC</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v_bins</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">h_bins</span><span class="p">}</span></div>
    
<div class="viewcode-block" id="DRFSC.load_data"><a class="viewcode-back" href="../../src.html#src.drfsc.DRFSC.load_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
            <span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
            <span class="n">X_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
            <span class="n">Y_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
            <span class="n">Y_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
            <span class="n">X_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">Y_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">polynomial</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
            <span class="n">preprocess</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocesses the data in the required way for the DRFSC model. Can be used to load data into the model if it has not been loaded yet. Scales the data to [0,1] and creates polynomial expansion based on the passed &#39;polynomial&#39; parameter. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X_train : np.ndarray or pd.DataFrame </span>
<span class="sd">            Train set data</span>
<span class="sd">        X_val : np.ndarray or pd.DataFrame</span>
<span class="sd">            Validation set data</span>
<span class="sd">        Y_train : np.ndarray or pd.DataFrame</span>
<span class="sd">            Train set labels</span>
<span class="sd">        Y_val : np.ndarray or pd.DataFrame</span>
<span class="sd">            Validation set labels</span>
<span class="sd">        X_test : np.ndarray or pd.DataFrame, optional</span>
<span class="sd">            Test set data. Only required if postprocessing is required. Defaults to None.</span>
<span class="sd">        Y_test : np.ndarray or pd.DataFrame optional</span>
<span class="sd">            Test set labels. Only required if postprocessing is required. Defaults to None.</span>
<span class="sd">        polynomial : int, optional</span>
<span class="sd">            degree of polynomial features to use. Defaults to 1.</span>
<span class="sd">        preprocess : bool, optional</span>
<span class="sd">            If True, will scale-data, create dummies for categorical variables, and create polynomial features based on passed `polynomial` parameter. If False, will only convert data to numpy arrays. Defaults to True.</span>

<span class="sd">        Returns </span>
<span class="sd">        -------</span>
<span class="sd">        X_train, X_val, Y_train, Y_val, X_test, Y_test : np.ndarray</span>
<span class="sd">            Preprocessed data and labels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">preprocess</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">polynomial</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Polynomial must be an integer&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">polynomial</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Polynomial must be greater than 0&quot;</span><span class="p">)</span>
                
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extend_features</span><span class="p">(</span><span class="n">scale_data</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">degree</span><span class="o">=</span><span class="n">polynomial</span><span class="p">),</span> <span class="p">[</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">])</span>
            
            <span class="k">if</span> <span class="n">X_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">X_test</span> <span class="o">=</span> <span class="n">extend_features</span><span class="p">(</span><span class="n">scale_data</span><span class="p">(</span><span class="n">X_test</span><span class="p">),</span> <span class="n">degree</span><span class="o">=</span><span class="n">polynomial</span><span class="p">)</span> 
    
        <span class="bp">self</span><span class="o">.</span><span class="n">input_feature_names</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_label_names</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_val</span><span class="p">]):</span>
            <span class="n">_check_type</span><span class="p">(</span>
                <span class="n">X_train</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> 
                <span class="n">X_val</span><span class="o">=</span><span class="n">X_val</span><span class="p">,</span> 
                <span class="n">X_test</span><span class="o">=</span><span class="n">X_test</span><span class="p">,</span> 
                <span class="n">Y_train</span><span class="o">=</span><span class="n">Y_train</span><span class="p">,</span> 
                <span class="n">Y_val</span><span class="o">=</span><span class="n">Y_val</span><span class="p">,</span> 
                <span class="n">Y_test</span><span class="o">=</span><span class="n">Y_test</span>
            <span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">input_feature_names</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                              
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">Y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Y_train</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">Y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">Y_train</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exlude</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">]))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">input_label_names</span> <span class="o">=</span> <span class="n">Y_train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span> <span class="c1"># set input_label_names for pd.Series</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input_label_names</span> <span class="o">=</span> <span class="n">Y_train</span><span class="o">.</span><span class="n">name</span> 
                
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_val</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="p">[</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_val</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
            <span class="n">Y_test</span> <span class="o">=</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            
        <span class="n">Y_test</span> <span class="o">=</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">if</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">Y_test</span>
        
        <span class="n">validate_data</span><span class="p">(</span>
            <span class="n">X_train</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> 
            <span class="n">X_val</span><span class="o">=</span><span class="n">X_val</span><span class="p">,</span> 
            <span class="n">X_test</span><span class="o">=</span><span class="n">X_test</span><span class="p">,</span> 
            <span class="n">Y_train</span><span class="o">=</span><span class="n">Y_train</span><span class="p">,</span> 
            <span class="n">Y_val</span><span class="o">=</span><span class="n">Y_val</span><span class="p">,</span> 
            <span class="n">Y_test</span><span class="o">=</span><span class="n">Y_test</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_data</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_val</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">data_info</span><span class="p">(</span>
            <span class="n">X_train</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> 
            <span class="n">X_val</span><span class="o">=</span><span class="n">X_val</span><span class="p">,</span> 
            <span class="n">Y_train</span><span class="o">=</span><span class="n">Y_train</span><span class="p">,</span> 
            <span class="n">Y_val</span><span class="o">=</span><span class="n">Y_val</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">Y_test</span></div>
    
<div class="viewcode-block" id="DRFSC.fit"><a class="viewcode-back" href="../../src.html#src.drfsc.DRFSC.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
            <span class="n">X_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>  
            <span class="n">Y_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
            <span class="n">Y_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The main function for fitting the model. Returns the a single final model if output == &#39;single&#39;, else returns a model ensemble based on the number of horizontal partitions (n_hbins).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X_train : np.ndarray or pd.DataFrame </span>
<span class="sd">            Train set data</span>
<span class="sd">        X_val : np.ndarray or pd.DataFrame</span>
<span class="sd">            Validation set data</span>
<span class="sd">        Y_train : np.ndarray or pd.DataFrame</span>
<span class="sd">            Train set labels</span>
<span class="sd">        Y_val : np.ndarray or pd.DataFrame</span>
<span class="sd">            Validation set labels</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_data</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_val</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span>
                                                        <span class="n">X_train</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> 
                                                        <span class="n">X_val</span><span class="o">=</span><span class="n">X_val</span><span class="p">,</span> 
                                                        <span class="n">Y_train</span><span class="o">=</span><span class="n">Y_train</span><span class="p">,</span> 
                                                        <span class="n">Y_val</span><span class="o">=</span><span class="n">Y_val</span><span class="p">,</span> 
                                                        <span class="n">polynomial</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">polynomial</span><span class="p">,</span> 
                                                        <span class="n">preprocess</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span>
                                                    <span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_val</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Data must be numpy arrays&quot;</span><span class="p">)</span>
        
        <span class="n">n_samples</span><span class="p">,</span> <span class="n">n_features</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="c1"># create vertical and horizontal paritions</span>
        <span class="n">distributed_features</span><span class="p">,</span> <span class="n">distributed_samples</span> <span class="o">=</span> <span class="n">create_balanced_distributions</span><span class="p">(</span>
                                                        <span class="n">labels</span><span class="o">=</span><span class="n">Y_train</span><span class="p">,</span> 
                                                        <span class="n">n_feats</span><span class="o">=</span><span class="n">n_features</span><span class="p">,</span> 
                                                        <span class="n">n_vbins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_vbins</span><span class="p">,</span> 
                                                        <span class="n">n_hbins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_hbins</span>
                                                    <span class="p">)</span> 
        
        <span class="c1"># Initializations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">J_star</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_hbins</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">J_best</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_hbins</span><span class="p">)}</span> <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_full</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">M_history</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">M</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_hbins</span><span class="p">)}</span> 
        <span class="n">non_converged_hbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_hbins</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of Samples: </span><span class="si">{</span><span class="n">n_samples</span><span class="si">}</span><span class="s2">. Horizontal Disitribution SHAPE: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">distributed_samples</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of Features: </span><span class="si">{</span><span class="n">n_features</span><span class="si">}</span><span class="s2">. Vertical Distribution SHAPE: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">distributed_features</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_runs</span><span class="p">):</span>
            <span class="n">iter_results</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># initialise dictionary for storing results</span>
            
            <span class="n">subprocesses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_processes</span><span class="p">(</span>
                                    <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> 
                                    <span class="n">v_bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_vbins</span><span class="p">,</span> 
                                    <span class="n">h_bins</span><span class="o">=</span><span class="n">non_converged_hbins</span>
                                <span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">redistribute_features</span><span class="p">:</span>
                <span class="n">distributed_features</span><span class="p">,</span> <span class="n">_</span><span class="o">=</span> <span class="n">create_balanced_distributions</span><span class="p">(</span>
                                            <span class="n">labels</span><span class="o">=</span><span class="n">Y_train</span><span class="p">,</span> 
                                            <span class="n">n_feats</span><span class="o">=</span><span class="n">n_features</span><span class="p">,</span> 
                                            <span class="n">n_vbins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_vbins</span><span class="p">,</span> 
                                            <span class="n">n_hbins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_hbins</span>
                                        <span class="p">)</span>
                
            <span class="c1"># loads data to all sub-processes</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">subprocesses</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  
                <span class="n">_</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">key</span>
                <span class="n">subprocesses</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">set_attr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RFSC_model</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
                <span class="n">subprocesses</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">load_data_rfsc</span><span class="p">(</span>
                                    <span class="n">X_train</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> 
                                    <span class="n">X_val</span><span class="o">=</span><span class="n">X_val</span><span class="p">,</span> 
                                    <span class="n">Y_train</span><span class="o">=</span><span class="n">Y_train</span><span class="p">,</span> 
                                    <span class="n">Y_val</span><span class="o">=</span><span class="n">Y_val</span><span class="p">,</span> 
                                    <span class="n">feature_partition</span><span class="o">=</span><span class="n">distributed_features</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> 
                                    <span class="n">sample_partition</span><span class="o">=</span><span class="n">distributed_samples</span><span class="p">[:,</span><span class="n">j</span><span class="p">],</span> 
                                    <span class="n">drfsc_index</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> 
                                    <span class="n">M</span><span class="o">=</span><span class="n">M</span>
                                <span class="p">)</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="p">[]</span> 
            <span class="k">def</span> <span class="nf">store_results</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span> <span class="c1">#callback for mp</span>
                <span class="n">result_obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                
            <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="nb">min</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_vbins</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_converged_hbins</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_processes</span><span class="p">),</span> <span class="n">maxtasksperchild</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_vbins</span><span class="p">),</span> <span class="n">non_converged_hbins</span><span class="p">):</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span>
                        <span class="n">RFSC</span><span class="o">.</span><span class="n">fit_drfsc</span><span class="p">,</span> 
                        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">subprocesses</span><span class="p">[(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)],</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)),</span> 
                        <span class="n">callback</span><span class="o">=</span><span class="n">store_results</span>
                    <span class="p">)</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># close the pool to new tasks</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_obj</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_vbins</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_converged_hbins</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;result_obj length is </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result_obj</span><span class="p">)</span><span class="si">}</span><span class="s2">. Should be </span><span class="si">{</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_vbins</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_converged_hbins</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_obj</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
            
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_vbins</span><span class="p">),</span> <span class="n">non_converged_hbins</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">drfsc_index</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result_obj</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;missing result </span><span class="si">{</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_obj</span><span class="p">:</span>
                <span class="c1"># predict on all sub-processes</span>
                <span class="n">result</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">evaluation</span> <span class="o">=</span> <span class="n">evaluate_interim_model</span><span class="p">(</span>
                                                    <span class="n">model_features</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">features_</span><span class="p">,</span> 
                                                    <span class="n">X_train</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> 
                                                    <span class="n">X_val</span><span class="o">=</span><span class="n">X_val</span><span class="p">,</span>
                                                    <span class="n">Y_train</span><span class="o">=</span><span class="n">Y_train</span><span class="p">,</span> 
                                                    <span class="n">Y_val</span><span class="o">=</span><span class="n">Y_val</span><span class="p">,</span>
                                                    <span class="n">metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span>
                                                <span class="p">)</span> 
                <span class="n">iter_results</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">drfsc_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                
            <span class="c1"># update full results dict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results_full</span><span class="p">,</span> <span class="n">single_iter_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_full_results</span><span class="p">(</span>
                                                        <span class="n">results_full</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">results_full</span><span class="p">,</span> 
                                                        <span class="n">iter_results</span><span class="o">=</span><span class="n">iter_results</span>
                                                    <span class="p">)</span> 
            <span class="c1"># map local feature indices to global feature indices</span>
            <span class="n">single_iter_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_local_feats_to_gt</span><span class="p">(</span>
                                    <span class="n">iter_results</span><span class="o">=</span><span class="n">single_iter_results</span><span class="p">,</span> 
                                    <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> 
                                    <span class="n">hbins</span><span class="o">=</span><span class="n">non_converged_hbins</span>
                                <span class="p">)</span> 
            
            <span class="n">comb_sig_feats_gt</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">single_iter_results</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            
            <span class="c1"># update the current best results</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">J_best</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_star</span> <span class="o">=</span> <span class="n">update_best_models</span><span class="p">(</span>
                                            <span class="n">J_best</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">J_best</span><span class="p">,</span> 
                                            <span class="n">J_star</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">J_star</span><span class="p">,</span> 
                                            <span class="n">single_iter_results</span><span class="o">=</span><span class="n">single_iter_results</span><span class="p">,</span> 
                                            <span class="n">non_converged_hbins</span><span class="o">=</span><span class="n">non_converged_hbins</span><span class="p">,</span> 
                                            <span class="n">metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span>
                                        <span class="p">)</span> 
            
            <span class="c1"># update converged horizontal partitions</span>
            <span class="n">non_converged_hbins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convergence_check</span><span class="p">(</span>
                                        <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span>
                                        <span class="n">J_star</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">J_star</span><span class="p">,</span> 
                                        <span class="n">non_converged_hbins</span><span class="o">=</span><span class="n">non_converged_hbins</span>
                                    <span class="p">)</span> 
            
            <span class="c1"># update feature list shared with other partitions</span>
            <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_share</span><span class="p">(</span>
                    <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> 
                    <span class="n">results_full</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">results_full</span><span class="p">,</span> 
                    <span class="n">comb_sig_feats_gt</span><span class="o">=</span><span class="n">comb_sig_feats_gt</span><span class="p">,</span> 
                    <span class="n">non_converged_hbins</span><span class="o">=</span><span class="n">non_converged_hbins</span><span class="p">,</span> 
                    <span class="n">M</span><span class="o">=</span><span class="n">M</span>
                <span class="p">)</span> 
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;M: </span><span class="si">{</span><span class="n">M</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">M_history</span><span class="o">.</span><span class="n">update</span><span class="p">([(</span><span class="n">r</span><span class="p">,</span> <span class="n">M</span><span class="p">)])</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_converged_hbins</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All horizontal partitions have converged. Final iter count: </span><span class="si">{</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features_num</span> <span class="o">=</span> <span class="n">select_single_model</span><span class="p">(</span><span class="n">J_best</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">J_best</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">Logit</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_num</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;lbfgs&#39;</span><span class="p">)</span>
            
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_full</span><span class="o">.</span><span class="n">values</span><span class="p">():</span> 
            <span class="c1"># remove the features_passed from results_full</span>
            <span class="n">value</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> 
            
        <span class="k">return</span> <span class="bp">self</span></div>
    
<div class="viewcode-block" id="DRFSC.score"><a class="viewcode-back" href="../../src.html#src.drfsc.DRFSC.score">[docs]</a>    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
        <span class="n">Y_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
        <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used to evaluate the final model on the test set.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X_test : np.ndarray or pd.DataFrame</span>
<span class="sd">            Test set data</span>
<span class="sd">        Y_test : np.ndarray or pd.DataFrame or pd.Series</span>
<span class="sd">            Test set labels</span>
<span class="sd">        metric : str, optional</span>
<span class="sd">            Metric to use for evaluation. By default uses the metric specified in the constructor. Other options: (&#39;acc&#39;, &#39;roc_auc&#39;, &#39;weighted&#39;, &#39;avg_prec&#39;, &#39;f1&#39;, &#39;auprc&#39;).</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        evaluation : dict</span>
<span class="sd">            returns the score of the model based on the metric specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
            <span class="n">Y_test</span> <span class="o">=</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">Y_test</span> <span class="o">=</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">if</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">Y_test</span>

        <span class="n">eval_metric</span> <span class="o">=</span> <span class="n">metric</span> <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">model_score</span><span class="p">(</span>
                    <span class="n">method</span><span class="o">=</span><span class="n">eval_metric</span><span class="p">,</span> 
                    <span class="n">y_true</span><span class="o">=</span><span class="n">Y_test</span><span class="p">,</span> 
                    <span class="n">y_pred_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">),</span> 
                    <span class="n">y_pred_prob</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
                <span class="p">)</span>   
            
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">eval_metric</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">}</span></div>
                
<div class="viewcode-block" id="DRFSC.predict"><a class="viewcode-back" href="../../src.html#src.drfsc.DRFSC.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uses the best model to predict on the test set</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X_test : np.ndarray </span>
<span class="sd">            Test set data</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        np.ndarray containing the predicted labels</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;ensemble&#39;</span><span class="p">:</span>
            <span class="n">model_ens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_ensemble</span><span class="p">(</span>
                                        <span class="n">X_test</span><span class="o">=</span><span class="n">X_test</span><span class="p">,</span> 
                                        <span class="n">J_best</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">J_best</span><span class="p">,</span> 
                                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_ensemble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_feature_indices_to_names</span><span class="p">(</span>
                                        <span class="n">output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> 
                                        <span class="n">final_model</span><span class="o">=</span><span class="n">model_ens</span>
                                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_ensemble</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_pred</span><span class="p">[</span><span class="s1">&#39;majority&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            
        <span class="k">else</span><span class="p">:</span> <span class="c1"># output == &#39;single&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_pred</span></div>
    
    
<div class="viewcode-block" id="DRFSC.predict_proba"><a class="viewcode-back" href="../../src.html#src.drfsc.DRFSC.predict_proba">[docs]</a>    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uses the best model to predict on the test set, returns labels </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X_test : np.ndarray </span>
<span class="sd">            Test set data</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray containing the predicted probabilities</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;ensemble&#39;</span><span class="p">:</span>

            <span class="n">model_ens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_ensemble</span><span class="p">(</span>
                            <span class="n">X_test</span><span class="o">=</span><span class="n">X_test</span><span class="p">,</span> 
                            <span class="n">J_best</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">J_best</span><span class="p">,</span> 
                        <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_ensemble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_feature_indices_to_names</span><span class="p">(</span>
                                        <span class="n">output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> 
                                        <span class="n">final_model</span><span class="o">=</span><span class="n">model_ens</span>
                                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_ensemble</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_pred</span><span class="p">[</span><span class="s1">&#39;mean_prob&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        
        <span class="k">else</span><span class="p">:</span> <span class="c1">#self.output == &#39;single&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coef_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_num</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_feature_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_feature_indices_to_names</span><span class="p">(</span>
                                        <span class="n">output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> 
                                        <span class="n">final_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">features_num</span>
                                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_num</span>
            
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_pred</span></div>
        
<div class="viewcode-block" id="DRFSC.generate_ensemble"><a class="viewcode-back" href="../../src.html#src.drfsc.DRFSC.generate_ensemble">[docs]</a>    <span class="k">def</span> <span class="nf">generate_ensemble</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">X_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
            <span class="n">J_best</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the model ensemble based on the best model for each horizontal partition.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X_test : np.ndarray </span>
<span class="sd">            Test set data</span>
<span class="sd">        J_best : dict</span>
<span class="sd">            dictionary containing as keys the horizontal partition index and as values the best model for that partition (list) in terms of feature indices, performance evaluation (float), and metric used for evaluation (str)</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        ensemble : dict</span>
<span class="sd">            dictionary that contains as keys the names of the models making up the ensemble. For each key, the value is a list containing a list of the feature indices used for that model, and the model object itself.</span>
<span class="sd">        ensemble_proba : pd.DataFrame</span>
<span class="sd">            dataframe containing the predicted probabilities for each model in the ensemble</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;All inputs must be numpy arrays&quot;</span><span class="p">)</span>

        <span class="c1"># get the best model for each horizontal partition   </span>
        <span class="n">ensemble</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ensemble_proba</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">h_bin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_hbins</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">Logit</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">J_best</span><span class="p">[</span><span class="n">h_bin</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;lbfgs&#39;</span><span class="p">)</span>
            <span class="n">ensemble</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;model_h</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">h_bin</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">J_best</span><span class="p">[</span><span class="n">h_bin</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">model</span><span class="p">]})</span>
            <span class="n">ensemble_proba</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;model_h</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">h_bin</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:,</span> <span class="n">J_best</span><span class="p">[</span><span class="n">h_bin</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
            
        <span class="n">ensemble_proba</span><span class="p">[</span><span class="s1">&#39;mean_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensemble_proba</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ensemble_proba</span><span class="p">[</span><span class="s1">&#39;majority&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ensemble_proba</span><span class="p">[</span><span class="s1">&#39;mean_prob&#39;</span><span class="p">]]</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_pred</span> <span class="o">=</span> <span class="n">ensemble_proba</span>
        <span class="k">return</span> <span class="n">ensemble</span><span class="p">,</span> <span class="n">ensemble_proba</span></div>

<div class="viewcode-block" id="DRFSC.update_full_results"><a class="viewcode-back" href="../../src.html#src.drfsc.DRFSC.update_full_results">[docs]</a>    <span class="k">def</span> <span class="nf">update_full_results</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">results_full</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
            <span class="n">iter_results</span><span class="p">:</span> <span class="nb">dict</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the full results dictionary with the results from the current iteration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">single_iter_results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">result</span><span class="o">.</span><span class="n">drfsc_index</span> <span class="p">:</span> 
                <span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">features_</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">evaluation</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">features_passed</span><span class="p">]</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">iter_results</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">results_full</span> <span class="o">=</span> <span class="n">results_full</span> <span class="o">|</span> <span class="n">single_iter_results</span>
        <span class="k">return</span> <span class="n">results_full</span><span class="p">,</span> <span class="n">single_iter_results</span></div>
    
<div class="viewcode-block" id="DRFSC.map_local_feats_to_gt"><a class="viewcode-back" href="../../src.html#src.drfsc.DRFSC.map_local_feats_to_gt">[docs]</a>    <span class="k">def</span> <span class="nf">map_local_feats_to_gt</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">iter_results</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
            <span class="n">r</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
            <span class="n">hbins</span><span class="p">:</span> <span class="nb">list</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Maps local feature indices to global feature indices for each model in the current iteration.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            iter_results : dict </span>
<span class="sd">                dict updated with global feature indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_vbins</span><span class="p">),</span> <span class="n">hbins</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">iter_results</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">iter_results</span><span class="p">[(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">iter_results</span><span class="p">[(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)][</span><span class="mi">3</span><span class="p">])[</span><span class="nb">list</span><span class="p">(</span><span class="n">iter_results</span><span class="p">[(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)][</span><span class="mi">0</span><span class="p">])])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iter_results</span><span class="p">[(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
        <span class="k">return</span> <span class="n">iter_results</span></div>
            
    
<div class="viewcode-block" id="DRFSC.feature_share"><a class="viewcode-back" href="../../src.html#src.drfsc.DRFSC.feature_share">[docs]</a>    <span class="k">def</span> <span class="nf">feature_share</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">r</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
            <span class="n">results_full</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
            <span class="n">comb_sig_feats_gt</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> 
            <span class="n">non_converged_hbins</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> 
            <span class="n">M</span><span class="p">:</span> <span class="nb">dict</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Computes the features to be shared with each bin in the subsequent iteration.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : int</span>
<span class="sd">            current iteration</span>
<span class="sd">        results_full : dict</span>
<span class="sd">            dictionary containing the results from all iterations</span>
<span class="sd">        comb_sig_feats_gt : list</span>
<span class="sd">            list of global feature indices from models in the current iteration</span>
<span class="sd">        non_converged_hbins : list </span>
<span class="sd">            list of horizontal partition indicies that have not converged</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        M : dict </span>
<span class="sd">            dictionary containing the features to be shared with each bin in the subsequent iteration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_sharing</span> <span class="o">==</span> <span class="s1">&#39;latest&#39;</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_hbins</span><span class="p">)}</span> <span class="c1"># reset M dict if feature sharing is set to latest</span>
        
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">non_converged_hbins</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;ensemble&#39;</span><span class="p">:</span>
                <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">remove_feature_duplication</span><span class="p">([</span><span class="n">results_full</span><span class="p">[(</span><span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_vbins</span><span class="p">)])</span>
            
            <span class="k">else</span><span class="p">:</span> <span class="c1">#self.output == &#39;single&#39;:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_sharing</span> <span class="o">==</span> <span class="s1">&#39;top_k&#39;</span><span class="p">:</span>
                    <span class="n">top_k_model_feats</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">results_full</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_full</span><span class="o">.</span><span class="n">values</span><span class="p">())))]</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">remove_feature_duplication</span><span class="p">(</span><span class="n">top_k_model_feats</span><span class="p">)</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">remove_feature_duplication</span><span class="p">(</span><span class="n">comb_sig_feats_gt</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">M</span></div>
    
<div class="viewcode-block" id="DRFSC.final_model"><a class="viewcode-back" href="../../src.html#src.drfsc.DRFSC.final_model">[docs]</a>    <span class="k">def</span> <span class="nf">final_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_ensemble</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function for generating the final model based on the ensemble of models.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_ensemble : dict</span>
<span class="sd">            contains the ensemble of models. Each key is a separate model, and the value is a list containing a list of the feature indices used for that model, the mapped feature names, and the model object itself.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">!=</span> <span class="s1">&#39;ensemble&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Final model only valid for ensemble output&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_feature_names</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_feature_names</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">model_ensemble</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span> 
        <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">model_ensemble</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span> 
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">model_ensemble</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">coefs</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">params</span>
            <span class="n">feat_index</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">feat_names</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">feat_index</span><span class="p">,</span> <span class="n">coefs</span><span class="p">):</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">feat_names</span><span class="p">,</span> <span class="n">coefs</span><span class="p">):</span>
                <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df2</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">model_coef</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_features_num</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_features_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="DRFSC.map_feature_indices_to_names"><a class="viewcode-back" href="../../src.html#src.drfsc.DRFSC.map_feature_indices_to_names">[docs]</a>    <span class="k">def</span> <span class="nf">map_feature_indices_to_names</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
            <span class="n">final_model</span><span class="p">:</span> <span class="nb">dict</span> <span class="ow">or</span> <span class="nb">list</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Maps the feature indices to the original feature names, if they exist.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output :str</span>
<span class="sd">            output type. Either &#39;single&#39; or &#39;ensemble&#39;.</span>
<span class="sd">        final_model : dict or list</span>
<span class="sd">            contains the converged models from the final iteration for each horizontal parition. If output is &#39;single&#39;, it is a single list, containing a list of feature indices and model object. If output is &#39;ensemble&#39;, it is a dictionary, with the keys being the horizontal partition index, and the values being a list containing the feature indices, and model object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        final_model : dict or list</span>
<span class="sd">            returns final_model with the feature indices mapped to the original feature names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;ensemble&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">final_model</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">final_model</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">final_model</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_feature_names</span><span class="p">)[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">final_model</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="n">final_model</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
                
        <span class="k">else</span><span class="p">:</span> <span class="c1">#output == &#39;single&#39;:</span>
            <span class="n">final_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_feature_names</span><span class="p">)[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">final_model</span><span class="p">]</span>
            
        <span class="k">return</span> <span class="n">final_model</span></div>
                
<div class="viewcode-block" id="DRFSC.convergence_check"><a class="viewcode-back" href="../../src.html#src.drfsc.DRFSC.convergence_check">[docs]</a>    <span class="k">def</span> <span class="nf">convergence_check</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">r</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
            <span class="n">J_star</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
            <span class="n">non_converged_hbins</span><span class="p">:</span> <span class="nb">list</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the tolerance condition has been met for the current iteration.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : int</span>
<span class="sd">            current interation number</span>
<span class="sd">        J_star : dict</span>
<span class="sd">            dictionary of best models from each horizontal partition.</span>
<span class="sd">        non_converged_hbins : list</span>
<span class="sd">            list of horizontal partitions that have not converged</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hbins_not_converged : list  </span>
<span class="sd">            indicies of horizontal partition that have not converged</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hbins_converged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">hbin</span> <span class="ow">in</span> <span class="n">non_converged_hbins</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">J_star</span><span class="p">[</span><span class="n">hbin</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">J_star</span><span class="p">[</span><span class="n">hbin</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iter </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">. The best model in hbin </span><span class="si">{</span><span class="n">hbin</span><span class="si">}</span><span class="s2"> cannot be improved further&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">hbins_converged</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hbin</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">r</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">J_star</span><span class="p">[</span><span class="n">hbin</span><span class="p">][</span><span class="n">r</span><span class="p">]</span> <span class="o">==</span> <span class="n">J_star</span><span class="p">[</span><span class="n">hbin</span><span class="p">][</span><span class="n">r</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">J_star</span><span class="p">[</span><span class="n">hbin</span><span class="p">][</span><span class="n">r</span><span class="p">]</span> <span class="o">==</span> <span class="n">J_star</span><span class="p">[</span><span class="n">hbin</span><span class="p">][</span><span class="n">r</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iter </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">. No appreciable improvement over the last 3 iterations in hbin </span><span class="si">{</span><span class="n">hbin</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">hbins_converged</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hbin</span><span class="p">)</span>
        
        <span class="n">hbins_not_converged</span> <span class="o">=</span> <span class="p">[</span><span class="nb">bin</span> <span class="k">for</span> <span class="nb">bin</span> <span class="ow">in</span> <span class="n">non_converged_hbins</span> <span class="k">if</span> <span class="nb">bin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hbins_converged</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">hbins_not_converged</span> </div>
        
<div class="viewcode-block" id="DRFSC.feature_importance"><a class="viewcode-back" href="../../src.html#src.drfsc.DRFSC.feature_importance">[docs]</a>    <span class="k">def</span> <span class="nf">feature_importance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a bar plot of the features of the model and their contribution to the final prediction.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        figure : matplotlib figure</span>
<span class="sd">            hisogram of feature coefficients for features of the final model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Feature Importance&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Feature Name&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Feature Coefficient&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;ensemble&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_feature_names</span><span class="p">)</span>
                <span class="n">cols</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;model_id&#39;</span><span class="p">)</span>
                <span class="n">coef</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_hbins</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_ensemble</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">coef</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">id</span><span class="p">,</span> <span class="s1">&#39;model_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
                    <span class="n">coef</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_ensemble</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_ensemble</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">params</span>
                <span class="n">coef</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coef</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">coef</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;model_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span>
                <span class="n">coef_arr</span> <span class="o">=</span> <span class="n">coef</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">coef_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coef_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        
                <span class="n">coef_idx</span> <span class="o">=</span> <span class="n">coef_arr</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            
                <span class="n">disp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_feature_names</span><span class="p">[</span><span class="n">coef_idx</span><span class="p">],</span> <span class="n">coef_arr</span><span class="p">[</span><span class="n">coef_idx</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Model has not been fit yet. Run .predict() or predict_proba() first&quot;</span><span class="p">)</span>  
            
        <span class="k">else</span><span class="p">:</span> <span class="c1">#self.output == &#39;single&#39;:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_feature_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">disp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_</span><span class="p">),</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Model has not been fit yet. Run .predict() or predict_proba() first&quot;</span><span class="p">)</span>  
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No feature names provided. Plotting feature indices instead&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">disp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_</span><span class="p">),</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Model has not been fit yet. Run .predict() or predict_proba() first&quot;</span><span class="p">)</span>  
                
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">disp</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span></div>
            
<div class="viewcode-block" id="DRFSC.pos_neg_prediction"><a class="viewcode-back" href="../../src.html#src.drfsc.DRFSC.pos_neg_prediction">[docs]</a>    <span class="k">def</span> <span class="nf">pos_neg_prediction</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">data_index</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">X_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a plot of the positive and negative parts of the prediction.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_index : int</span>
<span class="sd">            Index of the data observation to be plotted. If X_test is not provided, then the index is relative to the provided training/validation data. If X_test is provided, then the index is relative to the provided test data. Default is 0.</span>
<span class="sd">        X_test : np.array or pd.DataFrame</span>
<span class="sd">            Test data to be used for prediction. If provided, then the index is relative to the provided test data. Default is None.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        figure : matplotlib figure</span>
<span class="sd">            figure shows, for a given sample (indexed by data_index), the positive and negative parts of the prediction. That is, it takes the value of the coefficients and multiplies them by the feature values. The positive and negative parts of the prediction are then plotted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;ensemble&#39;</span><span class="p">:</span>
            <span class="n">features_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_features_num</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_coef</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">features_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_num</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_</span>
    
        <span class="k">if</span> <span class="n">X_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;X_test must be a numpy array or pandas dataframe&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                
            <span class="n">sample_data</span> <span class="o">=</span>  <span class="n">X_test</span><span class="p">[</span><span class="n">data_index</span><span class="p">,</span> <span class="n">features_num</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">sample_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data_index</span><span class="p">,</span> <span class="n">features_num</span><span class="p">]</span>

        <span class="n">y_neg</span><span class="p">,</span> <span class="n">y_pos</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">parameter_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coef</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">parameter_value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">y_neg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parameter_value</span> <span class="o">*</span> <span class="n">sample_data</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parameter_value</span> <span class="o">*</span> <span class="n">sample_data</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                
        <span class="n">y_neg_norm</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="nb">sum</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y_neg</span><span class="p">))))</span>
        <span class="n">y_pos_norm</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y_pos</span><span class="p">))))</span>
        <span class="n">disp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">((</span><span class="s1">&#39;y+&#39;</span><span class="p">,</span> <span class="s1">&#39;y-&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">y_pos_norm</span><span class="p">,</span> <span class="n">y_neg_norm</span><span class="p">)))</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;+/- Positive and Negative Parts of Prediction&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">disp</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span></div>
        
<div class="viewcode-block" id="DRFSC.single_prediction"><a class="viewcode-back" href="../../src.html#src.drfsc.DRFSC.single_prediction">[docs]</a>    <span class="k">def</span> <span class="nf">single_prediction</span><span class="p">(</span>            
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">data_index</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">X_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a plot of the single prediction of the final model</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_index : int</span>
<span class="sd">            Index of the data observation to be plotted. If X_test is not provided, then the index is relative to the provided training/validation data. If X_test is provided, then the index is relative to the provided test data. Default is 0.</span>
<span class="sd">        X_test : np.array or pd.DataFrame</span>
<span class="sd">            Test data to be used for prediction. If provided, then the index is relative to the provided test data. Default is None.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        figure : matplotlib figure</span>
<span class="sd">            Shows for a given sample (indexed by data_index) the coefficients of the final model, weighted by the feature values for the indexed observation. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;ensemble&#39;</span><span class="p">:</span>
            <span class="n">feat_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_features_num</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_coef</span>
            <span class="n">feat_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_features_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">feat_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_num</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_</span>
            <span class="n">feat_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_</span>
            
        <span class="k">if</span> <span class="n">X_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;X_test must be a numpy array or pandas dataframe&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        
            <span class="n">sample_data</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">data_index</span><span class="p">,</span> <span class="n">feat_num</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sample_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data_index</span><span class="p">,</span> <span class="n">feat_num</span><span class="p">]</span>
        
        <span class="n">disp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">feat_text</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sample_data</span><span class="p">,</span> <span class="n">coef</span><span class="p">)))</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Single Prediction Plot for Sample </span><span class="si">{</span><span class="n">data_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Sample-weighted prediction&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Feature Name&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">disp</span><span class="o">.</span> <span class="n">items</span><span class="p">()))</span></div></div>
    
<div class="viewcode-block" id="update_best_models"><a class="viewcode-back" href="../../src.html#src.drfsc.update_best_models">[docs]</a><span class="k">def</span> <span class="nf">update_best_models</span><span class="p">(</span>
        <span class="n">J_best</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
        <span class="n">J_star</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
        <span class="n">single_iter_results</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
        <span class="n">non_converged_hbins</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> 
        <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compares results from the current iteration against current best models. If a model from the current iteration is better, it is saved.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    J_best : dict</span>
<span class="sd">        dictionary containing as keys the horizontal partition index and as values the best model for that partition (list) in terms of feature indices, performance evaluation (float), and metric used for evaluation (str)</span>
<span class="sd">    J_star : dict</span>
<span class="sd">        dictionary containing only the performance evaluation of the best model for each horizontal partition (list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">single_iter_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">non_converged_hbins</span> <span class="ow">and</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">J_best</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New best model for hbin </span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2"> -- Model features </span><span class="si">{</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">J_best</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">non_converged_hbins</span><span class="p">:</span>
        <span class="n">J_star</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">J_best</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        
    <span class="k">return</span> <span class="n">J_best</span><span class="p">,</span> <span class="n">J_star</span></div>

<div class="viewcode-block" id="select_single_model"><a class="viewcode-back" href="../../src.html#src.drfsc.select_single_model">[docs]</a><span class="k">def</span> <span class="nf">select_single_model</span><span class="p">(</span><span class="n">J_best</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns model with highest performance evaluation</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    J_best : dict</span>
<span class="sd">        dictionary containing as keys the horizontal partition index and as values the best model for that partition (list) in terms of feature indices, performance evaluation (float), and metric used for evaluation (str)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    best_model : list</span>
<span class="sd">        List containing the best model for the entire dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">J_best</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">best_model</span></div>
    
<div class="viewcode-block" id="validate_data"><a class="viewcode-back" href="../../src.html#src.drfsc.validate_data">[docs]</a><span class="k">def</span> <span class="nf">validate_data</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_val</span><span class="p">,</span> <span class="n">X_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Y_test</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Checks data is of correct shape</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;X_train rows </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> must match Y_train </span><span class="si">{</span><span class="n">Y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">X_val</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Y_val</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;X_val and Y_val must have the same number of rows&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">X_val</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;X_train and X_val must have the same number of columns&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">X_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Y_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;X_test and Y_test must have the same number of rows&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;X_test and X_train must have the same number of columns&quot;</span><span class="p">)</span></div>
            
<span class="k">def</span> <span class="nf">_check_type</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_val</span><span class="p">,</span> <span class="n">X_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Y_test</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks data is of same type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">X_val</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;types </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span><span class="si">}</span><span class="s2"> do not match&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Y_train</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">Y_val</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;types </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">Y_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">Y_val</span><span class="p">)</span><span class="si">}</span><span class="s2"> do not match&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">X_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">X_train</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;types </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> do not match&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Y_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">Y_test</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">Y_train</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;types </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">Y_test</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">Y_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> do not match&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Y_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">Y_test</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">Y_val</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;types </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">Y_test</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">Y_val</span><span class="p">)</span><span class="si">}</span><span class="s2"> do not match&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="validate_model"><a class="viewcode-back" href="../../src.html#src.drfsc.validate_model">[docs]</a><span class="k">def</span> <span class="nf">validate_model</span><span class="p">(</span>
        <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
        <span class="n">n_hbins</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
        <span class="n">n_vbins</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
        <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
        <span class="n">feature_sharing</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks DRFSC initialised correctly</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;acc&#39;</span><span class="p">,</span> <span class="s1">&#39;roc_auc&#39;</span><span class="p">,</span> <span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="s1">&#39;avg_prec&#39;</span><span class="p">,</span> <span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="s1">&#39;auprc&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;metric must be one of: (&#39;acc&#39;, &#39;roc_auc&#39;, &#39;weighted&#39;, &#39;avg_prec&#39;, &#39;f1&#39;, &#39;auprc&#39;). Received </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_hbins</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_hbins must be an integer. Received </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">n_hbins</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_vbins</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_vbins must be an integer. Received </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">n_vbins</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="s1">&#39;ensemble&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;output must be one of: (&#39;single&#39;, &#39;ensemble&#39;). Received </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">feature_sharing</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;latest&#39;</span><span class="p">,</span> <span class="s1">&#39;top_k&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;feature_sharing must be one of: (&#39;all&#39;, &#39;latest&#39;, &#39;top_k&#39;). Received </span><span class="si">{</span><span class="n">feature_sharing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">feature_sharing</span> <span class="o">==</span> <span class="s1">&#39;top_k&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;k must be an integer. Received None&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;k must be of type int. Received </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
        


        
        

        
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2023, Mark Chiu Chong

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>